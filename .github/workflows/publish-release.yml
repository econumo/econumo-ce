name: Build on Release Creation

on:
  release:
    types: [published]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

concurrency:
  group: "docker-publish-release"
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  publish-release:
    if: startsWith(github.event.release.tag_name, 'release')
    uses: ./.github/workflows/embedded-build-package.yml
    with:
      REGISTRY: ${{ env.REGISTRY }}
      IMAGE_NAME: ${{ env.IMAGE_NAME }}
      IMAGE_VERSION: ${{ github.event.release.tag_name }}
    secrets:
      DOCKER_LOGIN: ${{ github.actor }}
      DOCKER_PASSWORD: ${{ secrets.BUILD_USER_TOKEN }}
      BUILD_USER_TOKEN: ${{ secrets.BUILD_USER_TOKEN }}

  publish-latest:
    uses: ./.github/workflows/embedded-build-package.yml
    with:
      REGISTRY: ${{ env.REGISTRY }}
      IMAGE_NAME: ${{ env.IMAGE_NAME }}
      IMAGE_VERSION: "latest"
    secrets:
      DOCKER_LOGIN: ${{ github.actor }}
      DOCKER_PASSWORD: ${{ secrets.BUILD_USER_TOKEN }}
      BUILD_USER_TOKEN: ${{ secrets.BUILD_USER_TOKEN }}
